<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mirror Intel – Daily News Briefing</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f4f4f4;
      padding: 30px;
      color: #333;
      max-width: 800px;
      margin: auto;
      transition: background 0.4s, color 0.4s;
    }
    h1 { color: #1e2a78; }
    button {
      padding: 10px 20px;
      font-size: 16px;
      background: #1e2a78;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      margin: 10px 10px 20px 0;
    }
    select {
      padding: 8px;
      margin-right: 10px;
      font-size: 16px;
    }
    .headline {
      background: white;
      padding: 15px;
      margin-bottom: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      position: relative;
    }
    .headline.breaking {
      border-left: 6px solid red;
      animation: pulse 1s infinite alternate;
    }
    @keyframes pulse {
      from { background-color: #fff; }
      to { background-color: #ffe5e5; }
    }
    .headline a {
      text-decoration: none;
      color: #1e2a78;
      font-weight: bold;
    }
    .share-icons {
      position: absolute;
      top: 10px;
      right: 10px;
      display: flex;
      gap: 10px;
    }
    .share-icon {
      cursor: pointer;
      opacity: 0.7;
      transition: transform 0.2s;
    }
    .share-icon:hover::after {
      content: attr(data-label);
      position: absolute;
      top: -25px;
      background: #333;
      color: #fff;
      font-size: 12px;
      padding: 4px 6px;
      border-radius: 4px;
      white-space: nowrap;
    }
    #mirror-summary, #gpt-digest {
      margin-top: 20px;
      font-style: italic;
      white-space: pre-line;
    }
    .dark-mode {
      background: #222;
      color: #eee;
    }
    .dark-mode .headline { background: #333; }
    .dark-mode .headline a { color: #aaddff; }
    .dark-mode button { background: #444; color: #fff; }
  </style>
</head>
  <!-- Manifest & Theme -->
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#1e2a78">

<!-- Icons -->
<link rel="icon" type="image/png" sizes="192x192" href="/mirrorintel-icon-192.png">
<link rel="apple-touch-icon" href="/mirrorintel-icon-512.png">

<!-- Service Worker Registration -->
<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/service-worker.js')
        .then(() => console.log("Service Worker registered"))
        .catch(err => console.error("SW registration failed", err));
    });
  }
</script>

<body>
<h1>🧠 Mirror Intel – Daily News Briefing</h1>

<label><strong>🌐 Select News Source:</strong></label>
<select id="source-select">
  <option disabled selected>────────</option>
  <option value="bbc">🌐 BBC World</option>
  <option value="cnn">🌐 CNN</option>
  <option value="aljazeera">🌐 Al Jazeera</option>
  <option value="timeslive">🇿🇦 ZA TimesLIVE</option>
  <option value="mg">🇿🇦 ZA Mail & Guardian</option>
</select>

<label><strong>🧠 Choose Topic:</strong></label>
<select id="topic-select">
  <option value="">-- All Topics --</option>
  <option value="tech">Technology</option>
  <option value="health">Health</option>
  <option value="finance">Finance</option>
  <option value="politics">Politics</option>
  <option value="climate">Climate</option>
  <option value="education">Education</option>
  <option value="security">Security</option>
  <option value="africa">Africa</option>
</select>

<button onclick="fetchNews()">🔄 Refresh Feed</button>
<button onclick="summarizeNews()">🧠 Mirror Summary</button>
<button onclick="generateAIDigest()">🤖 GPT Digest</button>
<button onclick="speakSummary()">🔊 Speak</button>
<button onclick="saveToVisionFlow()">📥 Save</button>
<button onclick="toggleDarkMode()">🌓 Dark Mode</button>
<button onclick="viewBookmarks()">📚 View Bookmarks</button>
<button onclick="window.location.href='subscribe.html'">💖 Support Mirror Intelligence</button>


<div id="news-container"></div>
<button id="prev-btn" onclick="showPrevPage()" style="display:none;">⬅️ Prev</button>
<button id="next-btn" onclick="showNextPage()" style="display:none;">Next ➡️</button>

<div id="mirror-summary"></div>
<div id="gpt-digest"></div>

<script>
let fullArticles = [];
let currentPage = 0;
const pageSize = 5;

function displayArticles(startIndex) {
  const container = document.getElementById("news-container");
  container.innerHTML = "";

  const pageArticles = fullArticles.slice(startIndex, startIndex + pageSize);

  pageArticles.forEach((article, index) => {
    const isBreaking = article.title.toLowerCase().includes("breaking") || article.description.toLowerCase().includes("breaking");
    const div = document.createElement("div");
    div.className = `headline${isBreaking ? ' breaking' : ''}`;
    div.innerHTML = `
      <div><strong>#${startIndex + index + 1}</strong></div>
      <div><a href="${article.url}" target="_blank">${article.title}</a></div>
      <div>${article.description || "No summary available."}</div>
      <div class="share-icons">
        <span class="share-icon" data-label="Copy Link" onclick="copyToClipboard('${article.url}')">🔗</span>
        <span class="share-icon" data-label="WhatsApp" onclick="shareWhatsApp('${article.url}')">📲</span>
        <span class="share-icon" data-label="Bookmark" onclick="bookmarkArticle(${startIndex + index})">🔖</span>
      </div>
    `;
    container.appendChild(div);
  });

  window.scrollTo(0, 0);
  document.getElementById("next-btn").style.display = startIndex + pageSize < fullArticles.length ? "inline-block" : "none";
  document.getElementById("prev-btn").style.display = startIndex > 0 ? "inline-block" : "none";
}

function showNextPage() {
  currentPage++;
  displayArticles(currentPage * pageSize);
}

function showPrevPage() {
  if (currentPage > 0) currentPage--;
  displayArticles(currentPage * pageSize);
}

async function fetchNews() {
  const container = document.getElementById("news-container");
  container.innerHTML = "<p>🧠 Scanning selected news feed...</p>";

  try {
    const selected = document.getElementById("source-select").value;
    const topic = document.getElementById("topic-select").value;
    const res = await fetch(`/api/fetch-news?source=${selected}&topic=${topic}`);
    const data = await res.json();

    fullArticles = data.articles || [];
    currentPage = 0;

    displayArticles(0);
  } catch (err) {
    console.error("❌ Fetch Error:", err);
    container.innerHTML = "<p>⚠️ Unable to load news. Check connection.</p>";
  }
}

function summarizeNews() {
  const articles = document.querySelectorAll(".headline");
  const summaryBox = document.getElementById("mirror-summary");
  if (articles.length === 0) return summaryBox.textContent = "⚠️ Fetch headlines first.";

  let content = "";
  articles.forEach((a, i) => {
    const title = a.querySelector("a").innerText;
    const desc = a.querySelector("div:last-child").innerText;
    content += `${i + 1}. ${title} - ${desc}\n`;
  });
  summaryBox.textContent = `Mirror Summary:\n\n${content.split("\n").slice(0, 3).join("\n")}`;
}

async function generateAIDigest() {
  const summaryBox = document.getElementById("gpt-digest");
  summaryBox.textContent = "🤖 Thinking...";
  const articles = [];
  document.querySelectorAll('.headline').forEach((el) => {
    const title = el.querySelector('a')?.innerText || '';
    const description = el.querySelector('div:last-child')?.innerText || '';
    articles.push({ title, description });
  });
  try {
    const res = await fetch('/api/gpt-summary', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ articles })
    });
    const result = await res.json();
    summaryBox.textContent = `🧠 GPT Digest:\n\n${result.summary}`;
  } catch (err) {
    summaryBox.textContent = "⚠️ Failed to generate GPT digest.";
  }
}

function speakSummary() {
  const summary = document.getElementById("mirror-summary").innerText;
  if (summary) speechSynthesis.speak(new SpeechSynthesisUtterance(summary));
}

function saveToVisionFlow() {
  const summary = document.getElementById("mirror-summary").innerText;
  if (!summary) return alert("Generate summary first.");
  alert("🧠 Saved to VisionFlow (simulated).");
}

function toggleDarkMode() {
  document.body.classList.toggle("dark-mode");
}

function copyToClipboard(url) {
  navigator.clipboard.writeText(url);
  alert("🔗 Link copied to clipboard");
}

function shareWhatsApp(url) {
  const message = `📰 Check this out: ${url}`;
  window.open(`https://wa.me/?text=${encodeURIComponent(message)}`);
}

function bookmarkArticle(index) {
  const article = fullArticles[index];
  article.savedAt = new Date().toLocaleString();
  const saved = JSON.parse(localStorage.getItem("mirrorBookmarks") || "[]");
  saved.push(article);
  localStorage.setItem("mirrorBookmarks", JSON.stringify(saved));
  alert("🔖 Article bookmarked!");
}

function viewBookmarks() {
  const container = document.getElementById("news-container");
  container.innerHTML = "";
  const saved = JSON.parse(localStorage.getItem("mirrorBookmarks") || "[]");
  if (!saved.length) return container.innerHTML = "<p>⚠️ No bookmarks saved yet.</p>";

  saved.forEach((article, index) => {
    const div = document.createElement("div");
    div.className = "headline";
    div.innerHTML = `
      <div><strong>#${index + 1}</strong> <em>(${article.savedAt})</em></div>
      <div><a href="${article.url}" target="_blank">${article.title}</a></div>
      <div>${article.description || "No summary available."}</div>
    `;
    container.appendChild(div);
  });

  window.scrollTo(0, 0);
  document.getElementById("next-btn").style.display = "none";
  document.getElementById("prev-btn").style.display = "none";
}

// Auto refresh every 10 minutes
setInterval(fetchNews, 600000);
</script>
</body>
</html>
